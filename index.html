<!DOCTYPE html>
<html>
<head>
	<!-- <script lang="javascript" src="assets/js/jquery-3.1.0.min.js"></script> -->
	<script lang="javascript" src="assets/js/d3.v4.min.js"></script>
	<link rel="stylesheet" href="assets/css/bar.css"/>
	<style>
		svg { font:10px sans-serif; }
		rect { stroke: #fff; }
	</style>
</head>
<body>
	<!-- <svg id="barchart"></svg> -->

	<script>

	// set the dimensions and margins of the graph
	var margin = {top: 20, right: 20, bottom: 30, left: 40},
	    width = 1500 - margin.left - margin.right,
	    height = 800 - margin.top - margin.bottom,
		padding = 25;

	// set the ranges
	var x = d3.scaleBand()
	          .range([0, width])
	          .padding(0.1);
	var y = d3.scaleLinear()
	          .range([height, 0]);

	// https://bl.ocks.org/d3noob/bdf28027e0ce70bd132edc64f1dd7ea4
	          
	// append the svg object to the body of the page
	// append a 'group' element to 'svg'
	// moves the 'group' element to the top left margin
	var svg = d3.select("body").append("svg")
	    .attr("width", width + margin.left + margin.right)
	    .attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")")
	//   .append("g")
	//     .attr("transform", 
	//           "translate(" + margin.left + "," + margin.top + ")");

	function filterIncident(data) {
		let fatalities = []
		let injuries = []
		let res = []
		data.forEach(function(element) {
			fatalities.push(element["fatalities"])
			injuries.push(element["injured"])
		});
		res[0] = fatalities
		res[1] = injuries
		return res
	}


	d3.queue()
	  .defer(d3.csv, "/assets/data/mass_shootings.csv")
	  .await(ready);

	const MAX_DOMAIN = 100

	function ready(error, data) {
		if (error) { console.log(error); }

		var yScale = d3.scaleLinear()
		.domain([0, MAX_DOMAIN])//d3.max(data, d => { return Number(d.total_victims); })])
		.range([height, 0]);
		
		var parseTime = d3.timeParse("%m/%d/%Y");
		var parseYear = d3.timeParse("%Y");

		var xScale = d3.scaleTime()
		.domain([parseYear("2002"), parseYear("2008")])
		.range([0, width]);

		var yAxis = d3.axisLeft(yScale)
		.ticks(10)
		.tickSize(5, 0, 0)
		.tickFormat(d => {return d})

		var xAxis = d3.axisBottom(xScale)
		.tickFormat(d3.timeFormat("%Y"))
		.ticks(20)

		var groups = svg.selectAll("g")
			.data(data).enter()
			.append("g")
			.attr("id", (d, i) => {return "g_" + i});
		
		groups
			.append("rect")
			.attr("x", (d) => {return xScale(parseTime(d.date))})
			.attr("y", (d) => {return yScale(d.total_victims)})
			.attr("width", 5)
			.attr("height", (d) => {return height - yScale(d.total_victims)})
			.style("fill", "black")
		
		groups
			.append("rect")
			.attr("x", (d) => {return xScale(parseTime(d.date))})
			.attr("y", (d) => {return yScale(d.fatalities)})
			.attr("width", 5)
			.attr("height", (d) => {return height - yScale(d.fatalities)})
			.style("fill", "red")
		
		svg.append("g")
			.attr("class", "y_axis")
			.call(yAxis);

		svg.append("g")
			.attr("class", "x_axis")
			.attr("transform", "translate(0," + height + ")")
			.call(xAxis);

	}

	function getYearlyVictims(data) {
		let yearlyVictims = {}
		data.forEach(function(element) {
			let year = (new Date(element["date"])).getFullYear()
			if (year in yearlyVictims) {
				yearlyVictims[year] += Number(element["total_victims"])
			} else {
				yearlyVictims[year] = Number(element["total_victims"])
			}
		})
		console.log(yearlyVictims)
		return yearlyVictims
	}

	</script>

</body>
</html>